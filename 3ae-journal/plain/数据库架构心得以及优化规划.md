# 数据库架构心得以及优化规划

| 修订版本 | 修订内容  | 修订人员 | 文档类型 | 修订日期 |
| :-----: |  :-----:  | :-----: | :-----: | :-----: |
|  v1.0.1.* | 新建数据库架构心得以及优化规划 | sid | -- | 2018-12-19 |
| ————— | —————————————————————————— | ————— | ————— | —————— |

版本号说明

* 版本号第四位: 修剪文档语句结构、内容布局，不计入修订版本。
* 版本号第三位: 二级模块内容、结构进行更新，计入修订版本。
* 版本号第二位: 一级模块内容、结构进行更新，计入修订版本。
* 版本号第一位: 不限于整个文档进行升级、包含的内容同时进行版本迭代，计入修订版本并生成新的文档。

修改文档名为：
1.快照版（同布更新）
2.稳定版（只维护，不更新）
3.最终版（不更新、不维护）

---

## mysql 二进制日志

mysql服务层日志

* 二进制日志
* 慢查日志
* 通用日志

mysql存储引擎层日志
innodb下

* 重做日志
* 回滚日志

### 二进制日志介绍

记录了所有对mysql数据库的修改事件、包括增删改查事件和对表结构修改事件

* 二进制日志格式

``` utf-8
1.基于段的格式 binlog_format = STATEMENT
   -- 5.7版本之前默认使用的二进制日志格式，记录Sql语句
   优点：
      1> 日志记录量相对较小，节约磁盘及网络I/O(每一个事件所执行的SQL语句，不需要记录每一行的具体变化，减少了存储量，提高了网络传输性能和磁盘存储性能)
   缺点：
      1> 必须记录语句执行上下文信息(保证主从数据库服务器上执行结果相同)
2.基于行的格式 binlog_forma = ROW
   -- 5.7之后默认
   优点：
      1> 使主从复制更安全
      2> 对每一行数据的修改比基于段的复制高效
   缺点：
      1> 记录日志量较大
         binlog_row_image = [FULL|MINIMAL|NOBLOB]
3.混合日志格式 binlog_format = MIXED
   特点：
      1> 根据SQL语句由系统决定在基于段和基于行的日志格式中选择
      2> 数据量的大小由所执行的SQL语句决定
建议：
      binlog_format = MIXED
   or
      binlog_forma = ROW
      binlog_row_image = minimal
```

### 二进制日志复制方式与影响

``` utf-8

1.基于SQL语句的复制SBR
   -- 5.1.4之前, 逻辑记录，主从库全部执行一遍
   优点：
      1> 生成的日志量少，节约网络传出I/O
      2> 并不强求主从数据库的表定义完全相同
      3> 相比于行的复制更灵活
   缺点：
      1> 对于非确定性事件，无法保证主从复制数据库的一致性
      2> 对于存储过程，触发器，自定义函数进行的修改也可能造成数据不一致
      3> 相比于基于行的复制方式在从上执行时需要更多的行锁

2.基于行的复制RBR
   优点：
      1> 可以应用于人任何SQL的复制包括非确定函数，存储过程等
      2> 可以减少数据库锁的使用
   缺点：
      1> 要求主从数据库的表结构相同，否则可能会中断复制
      2> 无法在从数据库上单独执行触发器
3.混合模式

```

表优化

```mysql
   1. decimal(8,2)
   2. tb_*_master    //有待商榷
   3. tb_order_buyer     // 用户，买家，收货人, 订单与用户表关联
   4. tb_order add user_id // order绑定user表，而不是tb_order_buyer
```